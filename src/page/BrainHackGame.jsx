import React, { useState } from "react";
import { useLocation, useNavigate } from "react-router-dom";
import { motion, AnimatePresence } from "framer-motion";
import PrimaryButton from "../components/PrimaryButton.jsx";
import IconPrimaryButton from "../components/IconPrimaryButton.jsx";
import brainplayerBG from "../assets/brainplayerBG.png";
import { theme } from "../theme.js";

export default function BrainHackGame() {
    const navigate = useNavigate();
    const location = useLocation();

    // üëá –ë–µ—Ä—ë–º –∏–≥—Ä–æ–∫–æ–≤, —É–∂–µ –ø–µ—Ä–µ–º–µ—à–∞–Ω–Ω—ã—Ö –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —ç–∫—Ä–∞–Ω–µ
    const players = location.state?.players || [];

    // üëá –ò–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
    const [currentIndex, setCurrentIndex] = useState(0);
    const currentPlayer = players[currentIndex];

    // === –ø–µ—Ä–µ—Ö–æ–¥—ã ===
    const handleNext = () => {
        if (currentIndex < players.length - 1) {
            setCurrentIndex((prev) => prev + 1);
        } else {
            // –≤—Å–µ —Å—Ö–æ–¥–∏–ª–∏ ‚Äî –ø–µ—Ä–µ—Ö–æ–¥ –∫ –∏–≥—Ä–µ / —Å–ª–µ–¥—É—é—â–µ–º—É —ç–∫—Ä–∞–Ω—É
            navigate("/game", { replace: true, state: { players } });
        }
    };

    const handleBack = () => {
        if (currentIndex > 0) setCurrentIndex((prev) => prev - 1);
        else navigate(-1);
    };

    return (
        <AnimatePresence>
            <motion.div
                key="player-turn-screen"
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
                transition={{ duration: 0.3 }}
                style={{
                    position: "fixed",
                    top: 0,
                    left: 0,
                    width: "100vw",
                    height: "100vh",
                    backgroundColor: "rgba(0,0,0,0.85)",
                    backdropFilter: "blur(8px)",
                    zIndex: 9999,
                    display: "flex",
                    justifyContent: "center",
                    alignItems: "center",
                }}
            >
                <motion.div
                    key="player-turn-container"
                    initial={{ scale: 0.95, opacity: 0 }}
                    animate={{ scale: 1, opacity: 1 }}
                    exit={{ scale: 0.9, opacity: 0 }}
                    transition={{ duration: 0.25 }}
                    style={{
                        width: "100%",
                        height: "100%",
                        position: "relative",
                        backgroundColor: theme.surface.main,
                        overflow: "hidden",
                        display: "flex",
                        flexDirection: "column",
                        alignItems: "center",
                        justifyContent: "center",
                    }}
                >
                    {/* —Ñ–æ–Ω */}
                    <img
                        src={brainplayerBG}
                        alt="background"
                        style={{
                            position: "absolute",
                            top: 0,
                            left: "50%",
                            transform: "translateX(-50%)",
                            width: "120%",
                            height: "auto",
                            objectFit: "cover",
                            zIndex: 0,
                            opacity: 0.8,
                        }}
                    />

                    {/* –ö–æ–Ω—Ç–µ–Ω—Ç –∏–≥—Ä–æ–∫–∞ */}
                    <div
                        style={{
                            position: "relative",
                            zIndex: 2,
                            display: "flex",
                            flexDirection: "column",
                            alignItems: "center",
                            justifyContent: "center",
                        }}
                    >
                        <motion.div
                            key={currentPlayer?.id}
                            initial={{ opacity: 0, scale: 0.8, y: 20 }}
                            animate={{ opacity: 1, scale: 1, y: 0 }}
                            exit={{ opacity: 0, scale: 0.8, y: -20 }}
                            transition={{ type: "spring", stiffness: 120, damping: 15 }}
                            style={{ textAlign: "center" }}
                        >
                            {/* –≠–º–æ–¥–∂–∏ –∏–≥—Ä–æ–∫–∞ */}
                            <div
                                style={{
                                    fontSize: 128,
                                    lineHeight: "128px",
                                    marginBottom: 32,
                                    userSelect: "none",
                                }}
                            >
                                {currentPlayer?.emojiData?.emoji || "üôÇ"}
                            </div>

                            {/* –ò–º—è –∏–≥—Ä–æ–∫–∞ */}
                            <div
                                style={{
                                    fontFamily: "Gilroy, sans-serif",
                                    fontWeight: 700,
                                    fontSize: 32,
                                    color: theme.icotex.white,
                                    marginBottom: 4,
                                }}
                            >
                                {currentPlayer?.emojiData?.name || "–ò–≥—Ä–æ–∫"}
                            </div>

                            {/* –ø–æ–¥–ø–∏—Å—å */}
                            <div
                                style={{
                                    fontFamily: "Gilroy, sans-serif",
                                    fontWeight: 400,
                                    fontSize: 18,
                                    color: theme.icotex.white,
                                    opacity: 0.9,
                                }}
                            >
                                —Ç–≤–æ–π —Ö–æ–¥
                            </div>
                        </motion.div>
                    </div>

                    {/* –ö–Ω–æ–ø–∫–∏ */}
                    <div
                        style={{
                            position: "absolute",
                            bottom:
                                "calc(max(var(--tg-content-safe-area-inset-bottom, 0px), var(--tg-safe-area-inset-bottom, 0px)) + 16px)",
                            left: 16,
                            right: 16,
                            zIndex: 10,
                            display: "flex",
                            justifyContent: "center",
                            gap: 8,
                        }}
                    >
                        <IconPrimaryButton onClick={handleBack} />
                        <PrimaryButton textColor={theme.icotex.white} onClick={handleNext}>
                            {currentIndex < players.length - 1 ? "–î–∞–ª—å—à–µ" : "–ù–∞—á–∞—Ç—å"}
                        </PrimaryButton>
                    </div>
                </motion.div>
            </motion.div>
        </AnimatePresence>
    );
}
